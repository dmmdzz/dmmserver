// internal/game_error/errors.go
package game_error

import (
	"fmt"
	"log"
	"strings"
)

// GameError 定义了我们游戏中的标准错误结构
type GameError struct {
	Code    int
	Message string // 原始消息模板
}

// Error 实现了 Go 的 error 接口
func (e *GameError) Error() string {
	return e.Message
}

// errorDefinitions 存储了所有预定义的错误码和消息模板
var errorDefinitions = map[int]string{
	-1:   "数据库连接错误，请重新登录",
	-2:   "数据库写入错误",
	-3:   "没有角色信息",
	-4:   "白金币或钻石不足",
	-5:   "参数丢失，请重新登录",
	-6:   "该物品已不在商店中",
	-7:   "使用了未拥有的皮肤",
	-8:   "重复购买",
	-9:   "没有房间信息",
	-10:  "没有奖励信息",
	-11:  "登录验证错误，账号或已在别处登录",
	-12:  "登录秘钥失效，请重新登录",
	-13:  "非法参数",
	-14:  "该手机号已绑定账号，无法新增绑定",
	-15:  "请求太过频繁，请稍后再试",
	-16:  "验证码已过期",
	-17:  "验证码错误，请重新输入",
	-18:  "登录失败，没有账号信息",
	-19:  "账号或密码不对",
	-20:  "OpenKey不匹配",
	-21:  "该用户名已存在，请重试",
	-22:  "非法用户名，请检查",
	-23:  "距上一次修改用户名的时间过短，请稍后再试",
	-24:  "操作失败，请稍后再试",
	-25:  "您已关注该用户",
	-26:  "该用户不是您的好友",
	-27:  "关注数量已达上限",
	-28:  "操作失败，请稍后再试",
	-29:  "该玩家不在游戏中",
	-30:  "没有照片",
	-31:  "角色信息不存在，请重试",
	-32:  "您已领取该奖励",
	-33:  "玩家是由他人邀请进入的",
	-34:  "该玩家还未进行游戏",
	-35:  "超过进入房间的时间限制，无法加入游戏",
	-36:  "您还未收到过他人赠送的花",
	-37:  "无法给自己送花",
	-38:  "您已领取过该奖励",
	-39:  "礼包卡号无效，请重试",
	-40:  "您已获得该奖励",
	-42:  "您已领取过该种礼包",
	-44:  "非法ID",
	-45:  "房间不存在",
	-46:  "奖励已领取",
	-51:  "兑换信息错误",
	-52:  "您的碎片不足",
	-53:  "该皮肤无法购买或合成",
	-54:  "操作失败（配置错误），请重试",
	-55:  "房间人数已满，无法加入",
	-56:  "您的段位与房间等级不匹配，无法加入",
	-57:  "您正在游戏中，无法加入新的游戏，请稍后再试",
	-58:  "转盘还未开启",
	-59:  "没有转盘次数",
	-60:  "宝箱不存在",
	-61:  "宝箱已经在解锁中",
	-62:  "连接Redis错误",
	-63:  "写入Redis错误",
	-64:  "宝箱还未解锁",
	-65:  "服务器逻辑错误",
	-66:  "转盘错误",
	-67:  "无法加入争霸赛，请重试",
	-68:  "比赛未开启，请稍候再试",
	-69:  "未获得决赛资格",
	-70:  "您已在自由战游戏中，无法进入其他游戏模式",
	-71:  "您已在争霸赛游戏中，无法进入其他游戏模式",
	-72:  "不允许中途加入团战赛",
	-73:  "自动登录凭据有效期已过，请重新登录",
	-74:  "您已在团战游戏中，无法进入其他游戏模式",
	-75:  "服务器配置错误",
	-76:  "邮件不存在",
	-77:  "邮件附件不存在",
	-78:  "请先领取邮件附件",
	-79:  "邮件处于未读状态",
	-80:  "分配团战准备房间失败",
	-81:  "邀请者已不在房间中，加入失败",
	-82:  "房间已在游戏中，加入失败",
	-83:  "团战组队房间没有人",
	-84:  "房间验证错误，请重新登录",
	-86:  "对方拒绝陌生人的团战邀请",
	-87:  "该队伍段位已发生变化，您的段位已不符合",
	-90:  "你不是贵族",
	-91:  "已领取了奖励",
	-92:  "领取首充奖励错误",
	-100: "无法找到该任务",
	-101: "无法领取未完成任务的奖励",
	-102: "无法重复领取奖励",
	-103: "无法再次重置任务",
	-104: "无法重置当日任务",
	-111: "验证支付超时",
	-112: "验证收据失败",
	-113: "无效的重复订单",
	-120: "活动未开启",
	-123: "工作人员正在审核，请勿重复举报",
	-124: "活动已结束",
	-130: "获取聊天的频道信息错误",
	-122: "等级太低，不能进争霸赛",
	-121: "今天已经打了8场争霸赛，不能继续",
	-131: "获取单服聊天信息错误",
	-135: "没有刷新次数",
	-136: "物品已过期",
	-137: "物品已购买",
	-140: "糖豆不足",
	-141: "糖豆太多了",
	-143: "乐斗模式不能中途加入",
	-144: "乐斗模式不支持观战",
	-145: "赠送已达最大次数",
	-146: "已经赠送过了哦",
	-147: "等级太低，不能参加乐斗模式",
	-148: "现在的时段乐斗模式不开放",
	-149: "此乱斗模式不允许加入比赛",
	-151: "皮肤和配饰不对应",
	-153: "找不到物品",
	-154: "未拥有的配饰",
	-155: "未拥有的挂件",
	-156: "出售数量超出实际拥有量",
	-157: "冗余碎片少于5个，不足以兑换万能碎片",
	-158: "皮肤数不足以激活奖励",
	-159: "皮肤已经达到最大等级",
	-170: "留言间隔太短",
	-171: "留言内容过长",
	-172: "留言不存在",
	-174: "该玩家设置仅关注用户可留言",
	-180: "服务器内部通信错误",
	-181: "批量请求内协议重发",
	-201: "错误的主题ID",
	-202: "没有免费的次数",
	-203: "白金币免费抽取次数用完",
	-204: "白金币免费抽取冷却中",
	-215: "今日兑换次数已用完",
	-224: "无法加入游戏，达到钻石段位后解锁乱斗玩法",
	-229: "重复领取荣耀之路奖励",
	-241: "重复解锁宝箱",
	-243: "请先解锁三号宝箱位",
	-230: "照片数量超过限制",
	-231: "今日奖励已领取",
	-232: "不可以打开这箱子",
	-233: "升星数不够",
	-212: "不能给自己照片点赞",
	-235: "超神战场禁止加入",
	-234: "您的账号因在近期涉嫌刷分被临时禁赛，禁赛解除时间：{0}，<br>请立即停止刷分行为，积极维护游戏竞技环境",
	-244: "玩家名或id不存在",
	-245: "邀请冷却中,请稍后再试",
	-250: "对方好友数已满",
	-251: "防沉迷收益降低状态不允许操作",
	-254: "账号已存在,绑定失败",
	-255: "该兑换码已被使用",
	-256: "无效的兑换码",
	-257: "今日次数已达上限",
	-258: "库存不足",
	-260: "已在家族中",
	-261: "没有家族信息",
	-262: "家族人数已满",
	-263: "家族名字已被占用",
	-264: "副族长人数超过限制",
	-265: "已经申请过这个家族",
	-266: "请求碎片已过期",
	-267: "今日已经捐满",
	-268: "权限不足",
	-269: "成员不止1人，族长不能退出",
	-270: "成员容量已到最大",
	-271: "最近已经申请了太多家族了",
	-272: "此家族已解散",
	-273: "该申请已失效",
	-274: "已经邀请过该玩家",
	-275: "家族最大人数已改变",
	-276: "玩家段位低于家族限制最低段位，无法加入",
	-277: "退出家族后24小时不能进入新家族",
	-278: "他暂时不能进新家族",
	-279: "今日已签到",
	-280: "该房间不存在",
	-281: "密码错误，请重试",
	-290: "数据不同步，点击确认重新刷新",
	-300: "已经领过该宝箱了",
	-301: "上一场家族战尚未完全结束 不能开始新的战斗",
	-302: " 本期家族战挑战次数已达上限",
	-510: "当前参与的小伙伴过多，请重新尝试哦",
	-530: "不能选择未开启的返场",
	-540: "您的账号已被注销，请联系客服处理",
	-541: "注销账户超时，请重新注销",
	-542: "您填写的信息有误，请重新填写",
	-543: "注销账户操作超时",
	-544: "（暂时无用的code配置，当前需和原540走的不同逻辑）",
	-999: "<color=#FFB900FF>游客</color>账号无法充值<br>请进入个人空间进行账号绑定",
	-1000: "自动登录凭据有效期已过，请重新登录",
	-2000: "拉取数据失败，请重试",
	-2001: "检测到服务器配置更新，请重新登录",
	-3000: "{0}",
	-3001: "{0}", // 封禁错误码，由中间件或 handler 返回
	1:    "账号已在别处登录，请重新登陆",
	2:    "包异常",
	3:    "服务器维护中，请稍后再试",
	4:    "上个玩家释放中",
	5:    "通过GM操作强制下线",
	6:    "过载保护",
	7:    "心跳踢人",
	8:    "账号可能已在别处登录，请重新启动游戏",
	9:    "远程Key验证失败",
	10:   "账号验证超时",
	11:   "DBS故障",
	12:   "CCS故障",
	13:   "LUA逻辑层的错误",
	14:   "角色ID和唯一服ID不匹配",
	15:   "消息长度错误",
	16:   "服务器还未开放，请稍后再试",
	17:   "重连失败，Session丢失，请重试",
	19:   "没有房间，不可进入",
	21:   "房间数已满",
	22:   "游戏模式不匹配",
	23:   "队伍人数已满",
	30:   "房间已满，加入失败",
	31:   "登录验证失败",
	32:   "没有房间可分配",
	33:   "没有权限",
	34:   "组队房间不存在，加入失败",
	35:   "邀请者已不在房间中，加入失败",
	36:   "仍有玩家还在结算中",
	38:   "当前队伍内有玩家的段位不符合",
	40:   "已经在游戏中了",
	41:   "参数校验失败",
	42:   "加入游戏失败，请重新匹配!",
	43:   "队伍人数不匹配，调整好了再开始吧",
	60:   "您因用户举报被禁止发言24小时",
	61:   "说话太快了，请休息一下",
	1000: "服务器返回未知消息",
	1001: "服务器返回消息反序列化失败",
}

// New 根据错误码创建一个新的 GameError 实例
// 它允许传入可选的参数来格式化错误消息 (例如替换 {0})
func New(code int, args ...string) *GameError {
	msgTemplate, ok := errorDefinitions[code]
	if !ok {
		// 如果错误码未定义，返回一个通用的服务器逻辑错误
		return &GameError{
			Code:    -65, // 服务器逻辑错误
			Message: fmt.Sprintf("Undefined error code used: %d", code),
		}
	}

	// 替换消息模板中的占位符
	if strings.Contains(msgTemplate, "{0}") && len(args) > 0 {
		msgTemplate = strings.Replace(msgTemplate, "{0}", args[0], -1)
	} else if len(args) > 0 {
		// 如果模板中没有占位符但传入了参数，记录警告或选择性地追加
		log.Printf("Warning: Parameters provided for error code %d but no {0} placeholder in message. Message: %s", code, msgTemplate)
	}

	return &GameError{
		Code:    code,
		Message: msgTemplate,
	}
}