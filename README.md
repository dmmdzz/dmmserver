
---

# "èº²çŒ«çŒ«å¤§ä½œæˆ˜" æ¸¸æˆå¤§å…æœåŠ¡å™¨åç«¯ (Go)

è¿™æ˜¯ä¸€ä¸ªåŸºäº Go è¯­è¨€æ„å»ºçš„é«˜æ€§èƒ½ã€é«˜æ‰©å±•æ€§çš„æ¸¸æˆå¤§å…æœåŠ¡å™¨åç«¯ã€‚é¡¹ç›®æ·±åº¦å€Ÿé‰´äº†ä¼˜ç§€å¼€æºé¡¹ç›® [Alist](https://github.com/alist-org/alist) çš„æ¨¡å—åŒ–è®¾è®¡æ€æƒ³ï¼Œæ—¨åœ¨æä¾›ä¸€ä¸ªç¨³å¥ã€å¯ç»´æŠ¤ä¸”æ˜“äºäºŒæ¬¡å¼€å‘çš„æœåŠ¡å™¨æ¡†æ¶ã€‚

## âœ¨ é¡¹ç›®ç‰¹è‰²

- **é«˜åº¦æ¨¡å—åŒ–**: é‡‡ç”¨åŸºäº`msg_id`çš„è‡ªæ³¨å†Œå¤„ç†å™¨ï¼ˆHandlerï¼‰ç³»ç»Ÿï¼Œæ–°å¢ä¸šåŠ¡é€»è¾‘å°±åƒæ·»åŠ ä¸€ä¸ªæ–°æ–‡ä»¶ä¸€æ ·ç®€å•ï¼Œæ— éœ€ä¿®æ”¹ä»»ä½•æ ¸å¿ƒä»£ç ã€‚
- **é…ç½®é©±åŠ¨**: æ ¸å¿ƒè¡Œä¸ºç”±é…ç½®æ–‡ä»¶é©±åŠ¨ï¼Œå¦‚æœåŠ¡å™¨ç«¯å£ã€æ•°æ®åº“è¿æ¥ï¼Œä»¥åŠå‰ç½®å®‰å…¨ç­–ç•¥çš„å“åº”æ ¼å¼ã€‚
- **å…³æ³¨ç‚¹åˆ†ç¦» (SoC)**: ä¸¥æ ¼åˆ†å±‚è®¾è®¡ï¼Œå°†ç½‘ç»œI/Oã€ä¸šåŠ¡é€»è¾‘ã€æ•°æ®è®¿é—®ã€åå°æœåŠ¡ç­‰å®Œå…¨è§£è€¦ã€‚
    - **ä¸šåŠ¡é€»è¾‘ä¸ä¼ è¾“è§£è€¦**: `Handler` åªè´Ÿè´£å¤„ç†çº¯ä¸šåŠ¡é€»è¾‘å¹¶è¿”å›æ•°æ®ï¼Œç”±`Dispatcher`ç»Ÿä¸€è´Ÿè´£å“åº”çš„æ ¼å¼åŒ–ä¸å‘é€ã€‚
    - **å®‰å…¨ç­–ç•¥ä¸ä¸šåŠ¡è§£è€¦**: å°ç¦ï¼ˆBanningï¼‰ç­‰é€šç”¨å®‰å…¨æ£€æŸ¥ä½œä¸ºå‰ç½®ä¸­é—´ä»¶å®ç°ï¼Œä¸šåŠ¡ä»£ç æ— éœ€å…³å¿ƒã€‚
- **æ™ºèƒ½åå°æœåŠ¡**: å®ç°äº†æŒ‰éœ€åˆ·æ–°çš„æ™ºèƒ½å°ç¦åˆ—è¡¨ç®¡ç†å™¨ï¼Œåœ¨ä¿è¯æ•°æ®å®‰å…¨çš„åŒæ—¶ï¼Œé¿å…äº†æœåŠ¡å™¨ç©ºé—²æ—¶ä¸å¿…è¦çš„æ•°æ®åº“è½®è¯¢ã€‚
- **ç»Ÿä¸€é”™è¯¯å¤„ç†**: å»ºç«‹äº†å…¨å±€çš„`game_error`ä¸­å¿ƒï¼Œä¸šåŠ¡ä»£ç åªéœ€è¿”å›é¢„å®šä¹‰çš„é”™è¯¯ï¼Œå³å¯ç”±æ¡†æ¶ç”Ÿæˆç»Ÿä¸€æ ¼å¼çš„é”™è¯¯å“åº”ã€‚
- **æ•°æ®åº“è‡ªè¿ç§»**: ä½¿ç”¨ GORM çš„`AutoMigrate`åŠŸèƒ½ï¼Œåœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æŸ¥å¹¶åˆ›å»ºä¸å­˜åœ¨çš„æ•°æ®è¡¨ï¼Œç®€åŒ–éƒ¨ç½²æµç¨‹ã€‚
- **å¯æ‰©å±•çš„æ•°æ®æ¨¡å‹**: å¹¿æ³›ä½¿ç”¨`JSON`æ•°æ®ç±»å‹æ¥å­˜å‚¨å¤æ‚çš„æ¸¸æˆæ•°æ®ï¼ˆå¦‚ç©å®¶èµ„äº§ã€å¡ç‰Œé…ç½®ç­‰ï¼‰ï¼Œåœ¨ç®€åŒ–æ•°æ®è¡¨ç»“æ„çš„åŒæ—¶ï¼Œä¿è¯äº†æ•°æ®è¯»å–çš„æ€§èƒ½ã€‚

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

é¡¹ç›®éµå¾ªäº† Go ç¤¾åŒºæ¨èçš„â€œæ ‡å‡†é¡¹ç›®å¸ƒå±€â€ï¼Œå¹¶è¿›è¡Œäº†å®šåˆ¶åŒ–è°ƒæ•´ï¼Œä»¥ä¿è¯å…¶æ¸…æ™°æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

```
unity-lobby-server/
â”œâ”€â”€ main.go                      # ç¨‹åºçš„å”¯ä¸€å…¥å£
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ bootstrap/               # å¯åŠ¨åè°ƒå™¨ï¼Œè´Ÿè´£æŒ‰é¡ºåºåˆå§‹åŒ–æ‰€æœ‰æ¨¡å—
â”‚   â”‚   â””â”€â”€ bootstrap.go
â”‚   â”œâ”€â”€ conf/                    # é…ç½®ä¸­å¿ƒ
â”‚   â”‚   â”œâ”€â”€ conf.go              # åŠ è½½ config.json æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ response_format.go   # ã€ä»£ç é…ç½®ã€‘å®šä¹‰ä¸åŒmsg_idçš„å°ç¦å“åº”æ ¼å¼
â”‚   â”œâ”€â”€ db/                      # æ•°æ®åº“æ¨¡å—ï¼Œè´Ÿè´£åˆå§‹åŒ–GORMå’Œè‡ªåŠ¨è¿ç§»
â”‚   â”‚   â””â”€â”€ db.go
â”‚   â”œâ”€â”€ game_error/              # å…¨å±€æ¸¸æˆé”™è¯¯ç å®šä¹‰ä¸­å¿ƒ
â”‚   â”‚   â””â”€â”€ errors.go
â”‚   â”œâ”€â”€ handler/                 # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ dispatcher.go        # Handlerçš„æ³¨å†Œä¸åˆ†å‘å™¨
â”‚   â”‚   â”œâ”€â”€ all.go               # ç”¨äºæ¿€æ´»æ‰€æœ‰handlerçš„"all"åŒ…ï¼ˆç¡®ä¿initè¢«è°ƒç”¨ï¼‰
â”‚   â”‚   â””â”€â”€ 30008.go             # ä¸šåŠ¡é€»è¾‘å¤„ç†å™¨ç¤ºä¾‹
â”‚   â”œâ”€â”€ model/                   # GORMæ•°æ®æ¨¡å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ ban.go
â”‚   â”‚   â””â”€â”€ player.go
â”‚   â”œâ”€â”€ server/                  # ç½‘ç»œå±‚ï¼Œè´Ÿè´£HTTPæœåŠ¡å™¨ã€è·¯ç”±å’Œä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ server.go
â”‚   â”œâ”€â”€ services/                # åå°æœåŠ¡æ¨¡å—ï¼ˆéç›´æ¥å“åº”è¯·æ±‚ï¼‰
â”‚   â”‚   â””â”€â”€ banning/             # è´¦å·å°ç¦åˆ—è¡¨ç®¡ç†æœåŠ¡
â”‚   â””â”€â”€ utils/                   # é€šç”¨å·¥å…·å‡½æ•°
â””â”€â”€ configs/
    â””â”€â”€ config.json              # è¿è¡Œæ—¶é…ç½®æ–‡ä»¶
```

## ğŸš€ æ ¸å¿ƒå·¥ä½œæµ

ç†è§£ä¸€ä¸ªè¯·æ±‚çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸæ˜¯æŒæ¡æ­¤æ¶æ„çš„å…³é”®ã€‚

#### 1. å¯åŠ¨æµç¨‹ (`bootstrap`)
1.  åŠ è½½ `configs/config.json`ã€‚
2.  åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ (`db`)ï¼Œå¹¶è‡ªåŠ¨è¿ç§»`model`ä¸­å®šä¹‰çš„è¡¨ã€‚
3.  **åŒ¿åå¯¼å…¥ `handler` åŒ…**ï¼Œè§¦å‘è¯¥åŒ…ä¸‹æ‰€æœ‰ `*.go` æ–‡ä»¶çš„ `init()` å‡½æ•°ï¼Œå®Œæˆæ‰€æœ‰`msg_id`å¤„ç†å™¨çš„â€œè‡ªæ³¨å†Œâ€ã€‚
4.  åˆå§‹åŒ–åå°æœåŠ¡ï¼Œå¦‚ `banning` æœåŠ¡ï¼ŒåŠ è½½åˆå§‹å°ç¦åˆ—è¡¨å¹¶å¯åŠ¨æ™ºèƒ½åˆ·æ–°åç¨‹ã€‚
5.  å¯åŠ¨ `Gin` Web æœåŠ¡å™¨ (`server`)ï¼Œå¼€å§‹ç›‘å¬ç«¯å£ã€‚

#### 2. è¯·æ±‚å¤„ç†æµç¨‹ (`server`)
*ï¼ˆä¸€ä¸ªå…¸å‹çš„ä¸­é—´ä»¶æµç¨‹å›¾å¯ä»¥å¾ˆå¥½åœ°è¯ é‡Šæœ¬é¡¹ç›®çš„è¯·æ±‚å¤„ç†æ–¹å¼ï¼‰*

ä¸€ä¸ªæ¥è‡ªUnityå®¢æˆ·ç«¯çš„`POST`è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨ï¼š
1.  **`activityMiddleware`**: ç¬¬ä¸€ä¸ªä¸­é—´ä»¶è¢«è§¦å‘ã€‚å®ƒé€šçŸ¥`banning`æœåŠ¡â€œæœ‰æ´»åŠ¨å‘ç”Ÿâ€ï¼Œå¹¶æ£€æŸ¥å°ç¦åˆ—è¡¨æ˜¯å¦â€œè¿‡æ—¶â€ï¼Œå¦‚æœè¿‡æ—¶åˆ™å¼ºåˆ¶åˆ·æ–°ã€‚
2.  **`banningEnforcementMiddleware`**: ç¬¬äºŒä¸ªä¸­é—´ä»¶æ¥ç®¡ã€‚
    -   å®ƒè§£æå‡º`msg_id`ã€`IP`ã€`DeviceID`ç­‰ä¿¡æ¯ã€‚
    -   ä¾æ¬¡æ£€æŸ¥è¿™äº›ä¿¡æ¯æ˜¯å¦å‘½ä¸­å°ç¦åˆ—è¡¨ã€‚
    -   **å¦‚æœå‘½ä¸­**ï¼šå®ƒä¼šæŸ¥è¯¢`conf/response_format.go`ä¸­çš„é…ç½®ï¼Œåˆ¤æ–­åº”è¿”å›`JSON`è¿˜æ˜¯`Text`ï¼Œç„¶åç›´æ¥æ„é€ å“åº”å¹¶**ä¸­æ­¢ï¼ˆAbortï¼‰**è¯·æ±‚ã€‚è¯·æ±‚ä¸ä¼šå†å‘åä¼ é€’ã€‚
    -   **å¦‚æœæœªå‘½ä¸­**ï¼šè°ƒç”¨`c.Next()`ï¼Œå°†è¯·æ±‚æ”¾è¡Œã€‚
3.  **`dispatchHandler`**: æœ€ç»ˆçš„å¤„ç†å™¨è¢«æ‰§è¡Œã€‚
    -   å®ƒä»ä¸­é—´ä»¶è®¾ç½®çš„ä¸Šä¸‹æ–‡ä¸­è·å–`msg_id`ã€‚
    -   é€šè¿‡`handler.GetHandler(msgID)`æ‰¾åˆ°å·²æ³¨å†Œçš„ã€å¯¹åº”çš„ä¸šåŠ¡å¤„ç†å™¨å‡½æ•°ã€‚
    -   è°ƒç”¨è¯¥å‡½æ•°ï¼Œå¹¶æ¥æ”¶è¿”å›çš„ `(æ•°æ®, é”™è¯¯)`ã€‚
    -   **å¦‚æœè¿”å›é”™è¯¯**: å®ƒä¼šæ ¹æ®é”™è¯¯ç±»å‹æ„é€ å¤±è´¥çš„JSONå“åº”ï¼ˆå¦‚`{"errorCode": -19}`ï¼‰ã€‚
    -   **å¦‚æœè¿”å›æˆåŠŸ**: å®ƒä¼šå°†è¿”å›çš„æ•°æ®ä¸`{"errorCode": 0}`åˆå¹¶ï¼Œæ„é€ æˆåŠŸçš„JSONå“åº”ã€‚
    -   **å‘é€å“åº”**: å°†æœ€ç»ˆæ„é€ å¥½çš„JSONå‘é€ç»™å®¢æˆ·ç«¯ã€‚

## âš™ï¸ å¿«é€Ÿå¼€å§‹

#### 1. å…ˆå†³æ¡ä»¶

-   [Go](https://golang.org/) (ç‰ˆæœ¬ >= 1.18)
-   ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ [MySQL](https://www.mysql.com/) æ•°æ®åº“å®ä¾‹

#### 2. å®‰è£…ä¸é…ç½®

1.  å…‹éš†æœ¬ä»“åº“åˆ°æ‚¨çš„æœ¬åœ°ï¼š
    ```bash
    git clone <your-repo-url>
    cd unity-lobby-server
    ```

2.  å®‰è£…Goä¾èµ–é¡¹ï¼š
    ```bash
    go mod tidy
    ```

3.  é…ç½®æœåŠ¡å™¨ã€‚å¤åˆ¶æˆ–é‡å‘½å`configs/config.json.example`ä¸º`configs/config.json`ï¼Œå¹¶ä¿®æ”¹å…¶ä¸­çš„å†…å®¹ï¼Œç‰¹åˆ«æ˜¯æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼š
    ```json
    {
      "server": {
        "port": "8080"
      },
      "database": {
        "type": "mysql",
        "host": "127.0.0.1",
        "port": 3306,
        "user": "your_db_user",
        "password": "your_db_password",
        "name": "dmmtestdata"
      }
    }
    ```

#### 3. è¿è¡ŒæœåŠ¡å™¨

ç›´æ¥åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ`main.go`å³å¯å¯åŠ¨æœåŠ¡å™¨ï¼š
```bash
go run main.go
```
æ‚¨å°†åœ¨æ§åˆ¶å°çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹çš„å¯åŠ¨æ—¥å¿—ï¼š
```
[GIN-debug] [WARNING] Creating an Engine instance with the Logger and Recovery middleware already attached.
...
[GIN-debug] POST   /                         --> unity-lobby-server/internal/server.dispatchHandler (3 handlers)
...
[GIN-debug] Listening and serving HTTP on :8080
```

## ğŸ“ å¦‚ä½•æ·»åŠ æ–°çš„ä¸šåŠ¡é€»è¾‘ (ä¾‹å¦‚ `msg_id=30009`)

å¾—ç›Šäºæ¨¡å—åŒ–çš„è®¾è®¡ï¼Œæ·»åŠ æ–°çš„ä¸šåŠ¡æ¥å£å˜å¾—æå…¶ç®€å•ã€‚

**ç¬¬1æ­¥ï¼šåœ¨`internal/handler/`ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶ `30009.go`ã€‚**

**ç¬¬2æ­¥ï¼šåœ¨è¯¥æ–‡ä»¶ä¸­ç¼–å†™æ‚¨çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶ä½¿ç”¨`init()`å‡½æ•°è¿›è¡Œè‡ªæ³¨å†Œã€‚**

```go
// internal/handler/30009.go
package handler

import (
	"log"

	"github.com/gin-gonic/gin"
	"unity-lobby-server/internal/game_error"
)

// initå‡½æ•°ä¼šåœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ
func init() {
	// å°†æˆ‘ä»¬çš„å¤„ç†å‡½æ•°æ³¨å†Œåˆ° msg_id "30009"
	Register("30009", handle30009)
}

// handle30009 æ˜¯å¤„ç†è´­ä¹°ç‰©å“çš„çº¯ä¸šåŠ¡é€»è¾‘å‡½æ•°
func handle30009(c *gin.Context, msgData map[string]interface{}) (map[string]interface{}, error) {
	// ä» msgData ä¸­è·å–å®¢æˆ·ç«¯ä¼ æ¥çš„å‚æ•°
	itemID, ok := msgData["itemID"].(float64) // JSONæ•°å­—é»˜è®¤è§£æä¸ºfloat64
	if !ok {
		// å¦‚æœå‚æ•°ä¸æ­£ç¡®ï¼Œè¿”å›ä¸€ä¸ªé¢„å®šä¹‰çš„é”™è¯¯
		return nil, game_error.New(-13) // éæ³•å‚æ•°
	}

	log.Printf("Player is trying to buy item: %d", int(itemID))
	
	// --- åœ¨è¿™é‡Œç¼–å†™æ‚¨çš„è´­ä¹°é€»è¾‘ ---
	// 1. æ£€æŸ¥ç©å®¶é‡‘å¸æ˜¯å¦è¶³å¤Ÿ
	// 2. ä»æ•°æ®åº“ä¸­æ‰£é™¤é‡‘å¸
	// 3. å°†ç‰©å“æ·»åŠ åˆ°ç©å®¶çš„èµ„äº§ä¸­
	// 4. ...

	// ä¸šåŠ¡å¤„ç†æˆåŠŸï¼Œè¿”å›éœ€è¦é¢å¤–å‘ç»™å®¢æˆ·ç«¯çš„æ•°æ®
	resultData := map[string]interface{}{
		"newItemCount": 5, // å‡è®¾ç©å®¶ç°åœ¨æœ‰5ä¸ªè¿™ä¸ªç‰©å“
		"goldRemained": 9500,  // å‰©ä½™é‡‘å¸
	}

	return resultData, nil
}
```

**ç¬¬3æ­¥ï¼šé‡æ–°å¯åŠ¨æœåŠ¡å™¨ã€‚**

å®Œæˆï¼æ‚¨ä¸éœ€è¦ä¿®æ”¹ä»»ä½•å…¶ä»–æ–‡ä»¶ã€‚æœåŠ¡å™¨ç°åœ¨å·²ç»å¯ä»¥å¤„ç†`msg_id=30009`çš„è¯·æ±‚äº†ã€‚

## ğŸ¨ è´¡çŒ®ä¸æœªæ¥æ–¹å‘

æ¬¢è¿å¯¹æœ¬é¡¹ç›®è¿›è¡Œè´¡çŒ®ã€‚ä¸€äº›å¯ä»¥æ¢ç´¢çš„æœªæ¥æ–¹å‘åŒ…æ‹¬ï¼š
-   å®ç°é…ç½®æ–‡ä»¶çš„çƒ­åŠ è½½ã€‚
-   å¼•å…¥Redisæ¥ç®¡ç†æ›´å®æ—¶çš„åœ¨çº¿çŠ¶æ€å’Œä¼šè¯æ•°æ®ã€‚
-   ç¼–å†™æ›´å…¨é¢çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ã€‚
-   ä¼˜åŒ–æ•°æ®åº“æ¨¡å‹ï¼Œå°†å¤§å‹JSONå­—æ®µæ ¹æ®æŸ¥è¯¢éœ€æ±‚æ‹†åˆ†ä¸ºæ›´å°çš„è¡¨ã€‚
